import { useState, useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import api from '../../services/api'
import { Chart as ChartJS, ArcElement, Tooltip, Legend, CategoryScale, LinearScale, BarElement, LineElement, PointElement } from 'chart.js'
import ChartDataLabels from 'chartjs-plugin-datalabels'
import { Bar, Doughnut, Line } from 'react-chartjs-2'
import AdminSidebar from '../../components/AdminSidebar'
import './Admin.css'

ChartJS.register(ArcElement, Tooltip, Legend, CategoryScale, LinearScale, BarElement, LineElement, PointElement, ChartDataLabels)

function AdminDashboard() {
  const navigate = useNavigate()
  const [loading, setLoading] = useState(true)
  const [stats, setStats] = useState({
    totalUsuarios: 0,
    totalSocios: 0,
    totalInstructores: 0,
    totalClases: 0,
    clasesHoy: 0,
    reservasMes: 0,
    reservasHoy: 0,
    ocupacionPromedio: 0
  })
  const [usuarios, setUsuarios] = useState([])
  const [clases, setClases] = useState([])
  const [reservas, setReservas] = useState([])

  useEffect(() => {
    verificarPermiso()
    cargarDatos()
  }, [])

  const verificarPermiso = () => {
    const userStr = localStorage.getItem('user')
    if (userStr) {
      const user = JSON.parse(userStr)
      if (user.rol !== 'administrador') {
        alert('No tienes permisos para acceder a esta secci√≥n')
        navigate('/clases')
      }
    }
  }

  const cargarDatos = async () => {
    try {
      setLoading(true)
      
      // Cargar usuarios
      const usuariosRes = await api.get('/usuarios/')
      const usuariosData = usuariosRes.data.results || usuariosRes.data || []
      setUsuarios(usuariosData)

      // Cargar clases
      const clasesRes = await api.get('/clases/')
      const clasesData = clasesRes.data.results || clasesRes.data || []
      setClases(clasesData)

      // Cargar reservas
      const reservasRes = await api.get('/reservas/')
      const reservasData = reservasRes.data.results || reservasRes.data || []
      setReservas(reservasData)

      // Calcular estad√≠sticas
      calcularEstadisticas(usuariosData, clasesData, reservasData)
    } catch (error) {
      console.error('Error cargando datos:', error)
      alert('Error al cargar los datos del dashboard')
    } finally {
      setLoading(false)
    }
  }

  const calcularEstadisticas = (usuarios, clases, reservas) => {
    const hoy = new Date().toISOString().split('T')[0]
    const mesActual = new Date().getMonth()
    const a√±oActual = new Date().getFullYear()

    const socios = usuarios.filter(u => u.rol === 'socio')
    const instructores = usuarios.filter(u => u.rol === 'instructor')
    const clasesHoy = clases.filter(c => c.fecha === hoy)
    
    const reservasMes = reservas.filter(r => {
      if (!r.fecha_reserva) return false
      const fecha = new Date(r.fecha_reserva)
      return fecha.getMonth() === mesActual && fecha.getFullYear() === a√±oActual
    })

    const reservasHoy = reservas.filter(r => {
      if (!r.clase?.fecha) return false
      return r.clase.fecha === hoy
    })

    // Calcular ocupaci√≥n promedio
    let totalOcupacion = 0
    let clasesConReservas = 0
    clases.forEach(clase => {
      const reservasClase = reservas.filter(r => r.clase?.id === clase.id && r.estado === 'confirmada')
      if (clase.cupos_totales > 0) {
        totalOcupacion += (reservasClase.length / clase.cupos_totales) * 100
        clasesConReservas++
      }
    })

    setStats({
      totalUsuarios: usuarios.length,
      totalSocios: socios.length,
      totalInstructores: instructores.length,
      totalClases: clases.length,
      clasesHoy: clasesHoy.length,
      reservasMes: reservasMes.length,
      reservasHoy: reservasHoy.length,
      ocupacionPromedio: clasesConReservas > 0 ? (totalOcupacion / clasesConReservas).toFixed(1) : 0
    })
  }

  // Datos para gr√°fico de usuarios por rol
  const usuariosPorRol = {
    labels: ['Socios', 'Instructores', 'Administradores'],
    datasets: [{
      label: 'Usuarios por Rol',
      data: [
        usuarios.filter(u => u.rol === 'socio').length,
        usuarios.filter(u => u.rol === 'instructor').length,
        usuarios.filter(u => u.rol === 'administrador').length
      ],
      backgroundColor: [
        'rgba(220, 38, 38, 0.9)',    // Rojo brillante
        'rgba(245, 158, 11, 0.9)',    // Naranja
        'rgba(147, 51, 234, 0.9)'     // P√∫rpura
      ],
      borderWidth: 3,
      borderColor: '#000000',
      hoverBackgroundColor: [
        'rgba(220, 38, 38, 1)',
        'rgba(245, 158, 11, 1)',
        'rgba(147, 51, 234, 1)'
      ],
      hoverBorderWidth: 4,
      hoverBorderColor: '#FFFFFF'
    }]
  }

  // Datos para gr√°fico de reservas por estado
  const reservasPorEstado = {
    labels: ['Confirmadas', 'Canceladas', 'No Show', 'Completadas'],
    datasets: [{
      label: 'Reservas por Estado',
      data: [
        reservas.filter(r => r.estado === 'confirmada').length,
        reservas.filter(r => r.estado === 'cancelada').length,
        reservas.filter(r => r.estado === 'noshow').length,
        reservas.filter(r => r.estado === 'completada').length
      ],
      backgroundColor: [
        'rgba(34, 197, 94, 0.9)',     // Verde
        'rgba(239, 68, 68, 0.9)',     // Rojo
        'rgba(251, 191, 36, 0.9)',    // Amarillo
        'rgba(59, 130, 246, 0.9)'     // Azul
      ],
      borderWidth: 3,
      borderColor: '#000000',
      hoverBackgroundColor: [
        'rgba(34, 197, 94, 1)',
        'rgba(239, 68, 68, 1)',
        'rgba(251, 191, 36, 1)',
        'rgba(59, 130, 246, 1)'
      ],
      hoverBorderWidth: 4,
      hoverBorderColor: '#FFFFFF'
    }]
  }

  // Datos para gr√°fico de clases m√°s populares
  const getClasesPopulares = () => {
    const clasesConReservas = clases.map(clase => ({
      nombre: clase.nombre,
      reservas: reservas.filter(r => r.clase?.id === clase.id && r.estado === 'confirmada').length
    }))
    .sort((a, b) => b.reservas - a.reservas)
    .slice(0, 5)

    return {
      labels: clasesConReservas.map(c => c.nombre),
      datasets: [{
        label: 'N√∫mero de Reservas',
        data: clasesConReservas.map(c => c.reservas),
        backgroundColor: [
          'rgba(220, 38, 38, 0.9)',
          'rgba(245, 158, 11, 0.9)',
          'rgba(34, 197, 94, 0.9)',
          'rgba(59, 130, 246, 0.9)',
          'rgba(147, 51, 234, 0.9)'
        ],
        borderColor: [
          'rgba(220, 38, 38, 1)',
          'rgba(245, 158, 11, 1)',
          'rgba(34, 197, 94, 1)',
          'rgba(59, 130, 246, 1)',
          'rgba(147, 51, 234, 1)'
        ],
        borderWidth: 2,
        hoverBackgroundColor: [
          'rgba(220, 38, 38, 1)',
          'rgba(245, 158, 11, 1)',
          'rgba(34, 197, 94, 1)',
          'rgba(59, 130, 246, 1)',
          'rgba(147, 51, 234, 1)'
        ]
      }]
    }
  }

  if (loading) {
    return (
      <div className="admin-layout">
        <AdminSidebar />
        <div className="admin-main">
          <div className="loading">Cargando dashboard...</div>
        </div>
      </div>
    )
  }

  return (
    <div className="admin-layout">
      <AdminSidebar />
      
      <div className="admin-main">
        {/* HEADER PRINCIPAL */}
        <div className="admin-top-header">
          <div className="header-left">
            <h1 className="dashboard-title">Dashboard Gimnasio</h1>
            <p className="dashboard-subtitle">Estado actual del gimnasio y actividad de socios</p>
          </div>
          <div className="header-right">
            <div className="search-box">
              <input type="text" placeholder="Buscar socio, clase o pago..." />
              <span className="search-icon">üîç</span>
            </div>
            <button className="notification-btn">
              <span>üîî</span>
              <span className="notification-badge">3</span>
            </button>
            <div className="user-menu">
              <div className="user-avatar">A</div>
              <div className="user-info">
                <span className="user-name">Angel</span>
                <span className="user-role">SUPERADMIN GYM</span>
              </div>
            </div>
          </div>
        </div>

        {/* CONTENIDO PRINCIPAL Y ACCIONES R√ÅPIDAS */}
        <div className="dashboard-content">
          <div className="main-content">
            {/* ESTAD√çSTICAS SUPERIORES */}
            <div className="stats-row">
              <div className="stat-card-modern">
                <div className="stat-icon-modern orange">üèãÔ∏è</div>
                <div className="stat-details">
                  <span className="stat-label">SOCIOS ACTIVOS</span>
                  <div className="stat-value-row">
                    <h2 className="stat-number">{stats.totalSocios}</h2>
                    <span className="stat-badge positive">+7 nuevos hoy</span>
                  </div>
                  <p className="stat-description">Membres√≠a al d√≠a</p>
                </div>
              </div>

              <div className="stat-card-modern">
                <div className="stat-icon-modern red">üíµ</div>
                <div className="stat-details">
                  <span className="stat-label">MOROSOS</span>
                  <div className="stat-value-row">
                    <h2 className="stat-number">23</h2>
                    <span className="stat-badge negative">-4</span>
                  </div>
                  <p className="stat-description">Pago vencido & acceso bloqueado</p>
                </div>
              </div>

              <div className="stat-card-modern">
                <div className="stat-icon-modern blue">ÔøΩ</div>
                <div className="stat-details">
                  <span className="stat-label">INGRESOS DE HOY</span>
                  <div className="stat-value-row">
                    <h2 className="stat-number">$410.000 CLP</h2>
                    <span className="stat-badge positive">+12%</span>
                  </div>
                  <p className="stat-description">Ventas de planes y pases diarios</p>
                </div>
              </div>

              <div className="stat-card-modern">
                <div className="stat-icon-modern purple">ÔøΩ</div>
                <div className="stat-details">
                  <span className="stat-label">OCUPACI√ìN CLASES</span>
                  <div className="stat-value-row">
                    <h2 className="stat-number">{stats.ocupacionPromedio}%</h2>
                    <span className="stat-badge positive">+3%</span>
                  </div>
                  <p className="stat-description">Promedio √∫ltimas 24h</p>
                </div>
              </div>
            </div>

            {/* TABLA DE SOCIOS RECIENTES */}
            <div className="table-section">
              <div className="table-header">
                <div>
                  <h3>Socios recientes</h3>
                  <p>√öltimos registros / renovaciones de plan</p>
                </div>
                <div className="table-actions">
                  <button className="btn-success" onClick={() => navigate('/admin/usuarios')}>
                    + Nuevo Socio
                  </button>
                  <button className="btn-secondary">Sincronizar</button>
                </div>
              </div>

              <div className="modern-table">
                <table>
                  <thead>
                    <tr>
                      <th>NOMBRE</th>
                      <th>PLAN</th>
                      <th>ESTADO</th>
                      <th>√öLTIMO ACCESO</th>
                      <th>PAGO HASTA</th>
                      <th>ACCIONES</th>
                    </tr>
                  </thead>
                  <tbody>
                    {usuarios.filter(u => u.rol === 'socio').slice(0, 4).map((usuario, idx) => (
                      <tr key={idx}>
                        <td>
                          <div className="user-cell">
                            <div className="user-avatar-small">{usuario.first_name?.[0] || usuario.username[0]}</div>
                            <span>{usuario.first_name} {usuario.last_name || usuario.username}</span>
                          </div>
                        </td>
                        <td>
                          <span className="plan-badge">PLAN FULL 24H</span>
                        </td>
                        <td>
                          <span className="status-badge active">‚óè Activo</span>
                        </td>
                        <td>31/10/2025 20:41 (GYM)</td>
                        <td>30/11/2025</td>
                        <td>
                          <div className="action-buttons">
                            <button className="btn-view" onClick={() => navigate(`/admin/usuarios`)}>Ver Perfil</button>
                            <button className="btn-suspend">Suspender</button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          {/* PANEL DE ACCIONES R√ÅPIDAS (DERECHA) */}
          <div className="quick-actions-panel">
            <div className="actions-header">
              <h3>Acciones r√°pidas</h3>
              <p>Atajos para el superadmin del gimnasio</p>
            </div>

            <div className="action-card">
              <div className="action-icon-badge green">üéì</div>
              <div className="action-content">
                <h4>Programar nueva clase grupal</h4>
                <p>Agrega Zumba, Funcional, Spinning, etc. Define cupos y coach.</p>
              </div>
              <span className="action-tag">CLASE</span>
            </div>

            <div className="action-card">
              <div className="action-icon-badge blue">üë§</div>
              <div className="action-content">
                <h4>Asignar entrenador personal</h4>
                <p>Vincula un entrenador a un socio o plan premium.</p>
              </div>
              <span className="action-tag">PT</span>
            </div>

            <div className="action-card">
              <div className="action-icon-badge red">üö´</div>
              <div className="action-content">
                <h4>Bloquear acceso por deuda</h4>
                <p>Marca moroso y desactiva QR/torniquete autom√°ticamente.</p>
              </div>
              <span className="action-tag">ACCESO</span>
            </div>

            <div className="action-card">
              <div className="action-icon-badge yellow">üìä</div>
              <div className="action-content">
                <h4>Reportar m√°quina en mal estado</h4>
                <p>Cinta, bici, etc. Queda como "No usar" en la sala.</p>
              </div>
              <span className="action-tag">MANTENCI√ìN</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

export default AdminDashboard

        <div className="charts-grid">
          <div className="chart-card">
            <h3>üë• DISTRIBUCI√ìN DE USUARIOS</h3>
            <div className="chart-container">
              <Doughnut 
                data={usuariosPorRol} 
                options={{ 
                  maintainAspectRatio: true,
                  responsive: true,
                  backgroundColor: 'transparent',
                  plugins: {
                    legend: {
                      position: 'bottom',
                      labels: { 
                        color: '#FFFFFF', 
                        font: { weight: 'bold', size: 13 },
                        padding: 15,
                        boxWidth: 15,
                        boxHeight: 15
                      }
                    },
                    tooltip: {
                      backgroundColor: 'rgba(0, 0, 0, 0.95)',
                      titleColor: '#FFFFFF',
                      bodyColor: '#FFFFFF',
                      borderColor: '#DC2626',
                      borderWidth: 3,
                      padding: 15,
                      displayColors: true,
                      boxWidth: 12,
                      boxHeight: 12,
                      callbacks: {
                        label: function(context) {
                          const label = context.label || '';
                          const value = context.parsed || 0;
                          const total = context.dataset.data.reduce((a, b) => a + b, 0);
                          const percentage = ((value / total) * 100).toFixed(1);
                          return `${label}: ${value} usuarios (${percentage}%)`;
                        }
                      }
                    },
                    datalabels: {
                      color: '#FFFFFF',
                      font: {
                        weight: 'bold',
                        size: 18
                      },
                      formatter: (value, context) => {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return `${percentage}%`;
                      },
                      textShadowColor: '#000000',
                      textShadowBlur: 8
                    }
                  }
                }} 
              />
            </div>
          </div>

          <div className="chart-card">
            <h3>üìÖ ESTADO DE RESERVAS</h3>
            <div className="chart-container">
              {reservas.length > 0 ? (
                <Doughnut 
                  data={reservasPorEstado} 
                  options={{ 
                    maintainAspectRatio: true,
                    responsive: true,
                    backgroundColor: 'transparent',
                    plugins: {
                      legend: {
                        position: 'bottom',
                        labels: { 
                          color: '#FFFFFF', 
                          font: { weight: 'bold', size: 13 },
                          padding: 15,
                          boxWidth: 15,
                          boxHeight: 15
                        }
                      },
                      tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.95)',
                        titleColor: '#FFFFFF',
                        bodyColor: '#FFFFFF',
                        borderColor: '#DC2626',
                        borderWidth: 3,
                        padding: 15,
                        displayColors: true,
                        boxWidth: 12,
                        boxHeight: 12,
                        callbacks: {
                          label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label}: ${value} reservas (${percentage}%)`;
                          }
                        }
                      },
                      datalabels: {
                        color: '#FFFFFF',
                        font: {
                          weight: 'bold',
                          size: 18
                        },
                        formatter: (value, context) => {
                          const total = context.dataset.data.reduce((a, b) => a + b, 0);
                          if (total === 0 || value === 0) return '';
                          const percentage = ((value / total) * 100).toFixed(1);
                          return `${percentage}%`;
                        },
                        textShadowColor: '#000000',
                        textShadowBlur: 8
                      }
                    }
                  }} 
                />
              ) : (
                <div className="no-data-chart">
                  <div className="no-data-icon">üìä</div>
                  <p className="no-data-text">Sin reservas registradas</p>
                  <span className="no-data-desc">Los datos aparecer√°n cuando haya reservas</span>
                </div>
              )}
            </div>
          </div>

          <div className="chart-card wide">
            <h3>üî• TOP 5 CLASES M√ÅS DEMANDADAS</h3>
            <div className="chart-container">
              {clases.length > 0 && getClasesPopulares().labels.length > 0 ? (
                <Bar 
                  data={getClasesPopulares()} 
                  options={{ 
                    maintainAspectRatio: true,
                    responsive: true,
                    plugins: {
                      legend: {
                        display: false
                      },
                      tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.95)',
                        titleColor: '#FFFFFF',
                        bodyColor: '#FFFFFF',
                        borderColor: '#DC2626',
                        borderWidth: 3,
                        padding: 15,
                        displayColors: true,
                        callbacks: {
                          label: function(context) {
                            return `Reservas: ${context.parsed.y}`;
                          }
                        }
                      },
                      datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: '#FFFFFF',
                        backgroundColor: '#DC2626',
                        borderRadius: 4,
                        padding: 6,
                        font: {
                          weight: 'bold',
                          size: 14
                        },
                        formatter: (value) => {
                          return value > 0 ? value : '';
                        }
                      }
                    },
                    scales: {
                      y: {
                        beginAtZero: true,
                        ticks: { 
                          stepSize: 1,
                          color: '#9CA3AF',
                          font: { weight: 'bold', size: 12 }
                        },
                        grid: { 
                          color: '#374151',
                          lineWidth: 1
                        }
                      },
                      x: {
                        ticks: { 
                          color: '#FFFFFF',
                          font: { weight: 'bold', size: 12 }
                        },
                        grid: { 
                          display: false
                        }
                      }
                    }
                  }} 
                />
              ) : (
                <div className="no-data-chart">
                  <div className="no-data-icon">üèãÔ∏è</div>
                  <p className="no-data-text">Sin clases registradas</p>
                  <span className="no-data-desc">Crea clases para ver las m√°s populares</span>
                </div>
              )}
            </div>
          </div>
        </div>
      </section>

      {/* SECCI√ìN 4: ACTIVIDAD RECIENTE */}
      <section className="dashboard-section">
        <div className="section-header">
          <h2 className="section-title">üïê ACTIVIDAD RECIENTE</h2>
          <p className="section-subtitle">√öltimas reservas registradas en el sistema</p>
        </div>

        <div className="recent-activity">
          <div className="activity-list">
            {reservas.length > 0 ? (
              reservas.slice(0, 8).map((reserva, idx) => (
                <div key={idx} className="activity-item">
                  <span className="activity-icon">
                    {reserva.estado === 'confirmada' ? '‚úÖ' : 
                     reserva.estado === 'cancelada' ? '‚ùå' : 
                     reserva.estado === 'completada' ? 'üéØ' : '‚ö†Ô∏è'}
                  </span>
                  <div className="activity-content">
                    <p>
                      <strong>{reserva.socio?.first_name || reserva.socio?.username || 'Usuario'}</strong> 
                      {' '}{reserva.estado === 'confirmada' ? 'reserv√≥' : 
                          reserva.estado === 'cancelada' ? 'cancel√≥' : 
                          reserva.estado === 'completada' ? 'complet√≥' : 'registr√≥'}{' '}
                      <strong>{reserva.clase?.nombre || 'una clase'}</strong>
                    </p>
                    <small>
                      {new Date(reserva.fecha_reserva).toLocaleDateString('es-ES', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                      })}
                    </small>
                  </div>
                  <span className={`activity-badge ${reserva.estado}`}>
                    {reserva.estado?.toUpperCase()}
                  </span>
                </div>
              ))
            ) : (
              <div className="no-results">
                <p>No hay actividad reciente</p>
              </div>
            )}
          </div>
        </div>
      </section>

      {/* SECCI√ìN 5: RESUMEN R√ÅPIDO */}
      <section className="dashboard-section">
        <div className="section-header">
          <h2 className="section-title">üí° RESUMEN EJECUTIVO</h2>
          <p className="section-subtitle">Informaci√≥n clave de un vistazo</p>
        </div>

        <div className="summary-cards">
          <div className="summary-card">
            <div className="summary-icon">üéØ</div>
            <div className="summary-content">
              <h4>CLASES HOY</h4>
              <p className="summary-number">{stats.clasesHoy}</p>
              <span className="summary-label">Sesiones programadas</span>
            </div>
          </div>

          <div className="summary-card">
            <div className="summary-icon">üë•</div>
            <div className="summary-content">
              <h4>SOCIOS ACTIVOS</h4>
              <p className="summary-number">{stats.totalSocios}</p>
              <span className="summary-label">Membres√≠as vigentes</span>
            </div>
          </div>

          <div className="summary-card">
            <div className="summary-icon">üèÜ</div>
            <div className="summary-content">
              <h4>RESERVAS HOY</h4>
              <p className="summary-number">{stats.reservasHoy}</p>
              <span className="summary-label">Confirmadas para hoy</span>
            </div>
          </div>

          <div className="summary-card">
            <div className="summary-icon">‚ö°</div>
            <div className="summary-content">
              <h4>INSTRUCTORES</h4>
              <p className="summary-number">{stats.totalInstructores}</p>
              <span className="summary-label">Equipo profesional</span>
            </div>
          </div>
        </div>
      </section>
    </div>
  )
}

export default AdminDashboard
